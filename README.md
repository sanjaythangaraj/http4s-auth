# Http4s Authentication

This is from the tutorial at [HTTP Authentication in Scala with Http4s: Passwords, Digests, Sessions, JWTs - Rock the JVM](https://www.youtube.com/watch?v=DxZIuvSDvyA)

## Basic Auth

### GET (without Basic Auth header)

```bash
curl -v localhost:8080/welcome
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
> GET /welcome HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
>
< HTTP/1.1 401 Unauthorized
< Date: Wed, 16 Apr 2025 17:18:58 GMT
< Connection: keep-alive
< Content-Length: 0
<
* Connection #0 to host localhost left intact
```


### GET (with Basic Auth header)

```bash
curl -v -H "Authorization:Basic c2FuamF5OnBhc3N3b3JkMTIz" localhost:8080/welcome
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
> GET /welcome HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
> Authorization:Basic c2FuamF5OnBhc3N3b3JkMTIz
>
* Request completely sent off
< HTTP/1.1 200 OK
< Date: Wed, 16 Apr 2025 16:56:39 GMT
< Connection: keep-alive
< Content-Type: text/plain; charset=UTF-8
< Content-Length: 23
<
Welcome, User(1,sanjay)* Connection #0 to host localhost left intact
```

`c2FuamF5OnBhc3N3b3JkMTIz` is base64 of `user:password`

## Digest

```bash
curl -v http://localhost:8080/welcome --digest -u daniel:rockthejvm
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
* Server auth using Digest with user 'daniel'
> GET /welcome HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
>
< HTTP/1.1 401 Unauthorized
< Date: Thu, 17 Apr 2025 08:45:19 GMT
< Connection: keep-alive
< WWW-Authenticate: Digest realm="http://localhost:8080",qop="auth",nonce="c0c7573a9d8f5a851e8882a0808dd966d0a9aa7d"
< Content-Length: 0
* Ignoring the response-body
<
* Connection #0 to host localhost left intact
* Issue another request to this URL: 'http://localhost:8080/welcome'
* Found bundle for host: 0x29502daf710 [serially]
* Re-using existing connection with host localhost
* Server auth using Digest with user 'daniel'
> GET /welcome HTTP/1.1
> Host: localhost:8080
> Authorization: Digest username="daniel",realm="http://localhost:8080",nonce="c0c7573a9d8f5a851e8882a0808dd966d0a9aa7d",uri="/welcome",cnonce="a35eb3a25d357aa5e6e3cc9a97013471",nc=00000001,response="d080e54127a3fd7daeee136fc4080f56",qop="auth"
> User-Agent: curl/8.9.1
> Accept: */*
>
* Request completely sent off
< HTTP/1.1 200 OK
< Date: Thu, 17 Apr 2025 08:45:20 GMT
< Connection: keep-alive
< Content-Type: text/plain; charset=UTF-8
< Content-Length: 23
<
Welcome, User(1,daniel)* Connection #0 to host localhost left intact
```

First, the client sends a `GET` request without any credentials or digest hash.
The server responds with `401` and a `WWW-Authenticate: Digest` header with `realm`, `qop` and `nonce` info.

The client then issues another request with `Authorization: Digest` header with `username`, `realm` (got from server),
`nonce` (got from server), `uri`, `cnonce` (generated by client), `nc` (nonce count), `response` (hash calculated by client), 'qop' (got from server).

when `qop="auth"`, the `response` is calculated as

```
response = MD5(HA1:nonce:nc:cnonce:qop:HA2)
```

where,

```
HA1 
    = MD5(user:realm:password) 
    = MD5("daniel:http://localhost:8080:rockthejvm") 
    = c49d3f1d0ce2b08797378861f607e786
```

This is the value that

`
Md5HashedAuthStore.precomputeHash[IO]("daniel", "http://localhost:8080", "rockthejvm")
`

computes.

and

```
HA2 
    = MD5(method:route) 
    = MD5("GET:/welcome") 
    = 3942a24b3d16939f60b7b35b5afe39cc
```

```
response 
    = MD5(HA1:nonce:nc:cnonce:qop:HA2) 
    = MD5(c49d3f1d0ce2b08797378861f607e786:c0c7573a9d8f5a851e8882a0808dd966d0a9aa7d:00000001:a35eb3a25d357aa5e6e3cc9a97013471:auth:3942a24b3d16939f60b7b35b5afe39cc)
    = d080e54127a3fd7daeee136fc4080f56
```

The middleware computes the expected response hash (from the HA1 computed on the fly in this example, precomputed value fetched from DB in a real world example) and compares it with the clientâ€™s response.