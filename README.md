# Http4s Authentication

This is from the tutorial at [HTTP Authentication in Scala with Http4s: Passwords, Digests, Sessions, JWTs - Rock the JVM](https://www.youtube.com/watch?v=DxZIuvSDvyA)

## Basic Auth

### GET (without Basic Auth header)

```bash
curl -v localhost:8080/welcome
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
> GET /welcome HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
>
< HTTP/1.1 401 Unauthorized
< Date: Wed, 16 Apr 2025 17:18:58 GMT
< Connection: keep-alive
< Content-Length: 0
<
* Connection #0 to host localhost left intact
```


### GET (with Basic Auth header)

```bash
curl -v -H "Authorization:Basic c2FuamF5OnBhc3N3b3JkMTIz" localhost:8080/welcome
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
> GET /welcome HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
> Authorization:Basic c2FuamF5OnBhc3N3b3JkMTIz
>
* Request completely sent off
< HTTP/1.1 200 OK
< Date: Wed, 16 Apr 2025 16:56:39 GMT
< Connection: keep-alive
< Content-Type: text/plain; charset=UTF-8
< Content-Length: 23
<
Welcome, User(1,sanjay)* Connection #0 to host localhost left intact
```

`c2FuamF5OnBhc3N3b3JkMTIz` is base64 of `user:password`

## Digest

```bash
curl -v http://localhost:8080/welcome --digest -u daniel:rockthejvm
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
* Server auth using Digest with user 'daniel'
> GET /welcome HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
>
< HTTP/1.1 401 Unauthorized
< Date: Thu, 17 Apr 2025 08:45:19 GMT
< Connection: keep-alive
< WWW-Authenticate: Digest realm="http://localhost:8080",qop="auth",nonce="c0c7573a9d8f5a851e8882a0808dd966d0a9aa7d"
< Content-Length: 0
* Ignoring the response-body
<
* Connection #0 to host localhost left intact
* Issue another request to this URL: 'http://localhost:8080/welcome'
* Found bundle for host: 0x29502daf710 [serially]
* Re-using existing connection with host localhost
* Server auth using Digest with user 'daniel'
> GET /welcome HTTP/1.1
> Host: localhost:8080
> Authorization: Digest username="daniel",realm="http://localhost:8080",nonce="c0c7573a9d8f5a851e8882a0808dd966d0a9aa7d",uri="/welcome",cnonce="a35eb3a25d357aa5e6e3cc9a97013471",nc=00000001,response="d080e54127a3fd7daeee136fc4080f56",qop="auth"
> User-Agent: curl/8.9.1
> Accept: */*
>
* Request completely sent off
< HTTP/1.1 200 OK
< Date: Thu, 17 Apr 2025 08:45:20 GMT
< Connection: keep-alive
< Content-Type: text/plain; charset=UTF-8
< Content-Length: 23
<
Welcome, User(1,daniel)* Connection #0 to host localhost left intact
```

First, the client sends a `GET` request without any credentials or digest hash.
The server responds with `401` and a `WWW-Authenticate: Digest` header with `realm`, `qop` and `nonce` info.

The client then issues another request with `Authorization: Digest` header with `username`, `realm` (got from server),
`nonce` (got from server), `uri`, `cnonce` (generated by client), `nc` (nonce count), `response` (hash calculated by client), 'qop' (got from server).

when `qop="auth"`, the `response` is calculated as

```
response = MD5(HA1:nonce:nc:cnonce:qop:HA2)
```

where,

```
HA1 
    = MD5(user:realm:password) 
    = MD5("daniel:http://localhost:8080:rockthejvm") 
    = c49d3f1d0ce2b08797378861f607e786
```

This is the value that

`
Md5HashedAuthStore.precomputeHash[IO]("daniel", "http://localhost:8080", "rockthejvm")
`

computes.

and

```
HA2 
    = MD5(method:route) 
    = MD5("GET:/welcome") 
    = 3942a24b3d16939f60b7b35b5afe39cc
```

```
response 
    = MD5(HA1:nonce:nc:cnonce:qop:HA2) 
    = MD5(c49d3f1d0ce2b08797378861f607e786:c0c7573a9d8f5a851e8882a0808dd966d0a9aa7d:00000001:a35eb3a25d357aa5e6e3cc9a97013471:auth:3942a24b3d16939f60b7b35b5afe39cc)
    = d080e54127a3fd7daeee136fc4080f56
```

The middleware computes the expected response hash (from the HA1 computed on the fly in this example, precomputed value fetched from DB in a real world example) and compares it with the clientâ€™s response.

## Session

```bash
curl -v localhost:8080/login/welcome --digest -u daniel:rockthejvm
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
* Server auth using Digest with user 'daniel'
> GET /login/welcome HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
>
* Request completely sent off
< HTTP/1.1 401 Unauthorized
< Date: Thu, 17 Apr 2025 16:55:48 GMT
< Connection: keep-alive
< WWW-Authenticate: Digest realm="http://localhost:8080",qop="auth",nonce="ac1c047ad2cfdbabe1d9a47493f578be70b45f63"
< Content-Length: 0
* Ignoring the response-body
<
* Connection #0 to host localhost left intact
* Issue another request to this URL: 'http://localhost:8080/login/welcome'
* Found bundle for host: 0x1a13bc9f7b0 [serially]
* Re-using existing connection with host localhost
* Server auth using Digest with user 'daniel'
> GET /login/welcome HTTP/1.1
> Host: localhost:8080
> Authorization: Digest username="daniel",realm="http://localhost:8080",nonce="ac1c047ad2cfdbabe1d9a47493f578be70b45f63",uri="/login/welcome",cnonce="489ddefb538c67f3aaa9c4b3d2147d9f",nc=00000001,response="420f219b051e7393be0ace151c07c4a2",qop="auth"
> User-Agent: curl/8.9.1
> Accept: */*
>
< HTTP/1.1 200 OK
< Date: Thu, 17 Apr 2025 16:55:48 GMT
< Connection: keep-alive
< Content-Type: text/plain; charset=UTF-8
< Content-Length: 23
< Set-Cookie: sessioncookie=ZGFuaWVsOjIyOjI1OjQ4LjQ5MDc4NTIwMA==; Max-Age=86400
<
Welcome, User(1,daniel)* Connection #0 to host localhost left intact
```

The `/login/welcome` endpoint when hit with the digest returns a `cookie` in `Set-Cookie` header.

The `sessioncookie` from the `Set-Cookie` header is then used to access routes protected by the cookie,
`/statement` and `/logout`.

`\statement` endpoint:

```bash
curl -v --cookie "sessioncookie=ZGFuaWVsOjIyOjI1OjQ4LjQ5MDc4NTIwMA==" http://localhost:8080/statement
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
> GET /statement HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
> Cookie: sessioncookie=ZGFuaWVsOjIyOjI1OjQ4LjQ5MDc4NTIwMA==
>
< HTTP/1.1 200 OK
< Date: Thu, 17 Apr 2025 17:57:22 GMT
< Connection: keep-alive
< Content-Type: text/plain; charset=UTF-8
< Content-Length: 39
<
Here is your financial statement daniel* Connection #0 to host localhost left intact
```

`/logout` endpoint

```bash
curl -v --cookie "sessioncookie=ZGFuaWVsOjIyOjI1OjQ4LjQ5MDc4NTIwMA==" http://localhost:8080/logout
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
> GET /logout HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
> Cookie: sessioncookie=ZGFuaWVsOjIyOjI1OjQ4LjQ5MDc4NTIwMA==
>
< HTTP/1.1 200 OK
< Date: Thu, 17 Apr 2025 17:59:13 GMT
< Connection: keep-alive
< Content-Type: text/plain; charset=UTF-8
< Content-Length: 11
< Set-Cookie: sessioncookie=; Expires=Thu, 01 Jan 1970 00:00:00 GMT
<
Logging out* Connection #0 to host localhost left intact
``` 

## JWT

```bash
curl -v localhost:8080/login/welcome --digest -u "daniel:rockthejvm"
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
* Server auth using Digest with user 'daniel'
> GET /login/welcome HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
>
* Request completely sent off
< HTTP/1.1 401 Unauthorized
< Date: Fri, 18 Apr 2025 06:03:14 GMT
< Connection: keep-alive
< WWW-Authenticate: Digest realm="http://localhost:8080",qop="auth",nonce="8bcd51a2ea06484fda991b34538c0db3d2cfcb49"
< Content-Length: 0
* Ignoring the response-body
<
* Connection #0 to host localhost left intact
* Issue another request to this URL: 'http://localhost:8080/login/welcome'
* Found bundle for host: 0x1eb04ce1630 [serially]
* Re-using existing connection with host localhost
* Server auth using Digest with user 'daniel'
> GET /login/welcome HTTP/1.1
> Host: localhost:8080
> Authorization: Digest username="daniel",realm="http://localhost:8080",nonce="8bcd51a2ea06484fda991b34538c0db3d2cfcb49",uri="/login/welcome",cnonce="ec42e6862e887426c9f40f880b9ff627",nc=00000001,response="5a350c1b89734999734e3bab80d3478e",qop="auth"
> User-Agent: curl/8.9.1
> Accept: */*
>
* Request completely sent off
< HTTP/1.1 200 OK
< Date: Fri, 18 Apr 2025 06:03:15 GMT
< Connection: keep-alive
< Content-Type: text/plain; charset=UTF-8
< Content-Length: 23
< Set-Cookie: token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE3NDU4MjAxMDQsImlhdCI6MTc0NDk1NjEwNCwNCiAidXNlciI6ICJkYW5pZWwiLA0KICJsZXZlbCI6ICJiYXNpYyINCn0.52ZIDnoNlk2JpL3AjRcQv4_GC1n2ElkxgGYllrmuB_c
<
Welcome, User(1,daniel)* Connection #0 to host localhost left intact
```

```bash
curl -v localhost:8080/guarded/secret -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE3NDU4MjAxMDQsImlhdCI6MTc0NDk1NjEwNCwNCiAidXNlciI6ICJkYW5pZWwiLA0KICJsZXZlbCI6ICJiYXNpYyINCn0.52ZIDnoNlk2JpL3AjRcQv4_GC1n2ElkxgGYllrmuB_c"
```

```
* Host localhost:8080 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:8080...
* Connected to localhost (::1) port 8080
> GET /guarded/secret HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/8.9.1
> Accept: */*
> Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE3NDU4MjAxMDQsImlhdCI6MTc0NDk1NjEwNCwNCiAidXNlciI6ICJkYW5pZWwiLA0KICJsZXZlbCI6ICJiYXNpYyINCn0.52ZIDnoNlk2JpL3AjRcQv4_GC1n2ElkxgGYllrmuB_c
>
< HTTP/1.1 200 OK
< Date: Fri, 18 Apr 2025 06:07:46 GMT
< Connection: keep-alive
< Content-Type: text/plain; charset=UTF-8
< Content-Length: 34
<
THIS IS THE SECRET, User(1,daniel)* Connection #0 to host localhost left intact
```